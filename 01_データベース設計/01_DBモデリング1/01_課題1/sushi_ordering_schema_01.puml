@startuml sushi_ordering_schema_01

skinparam {
  ' カーディナリティ斜め対策
   linetype ortho
}

' 顧客マスタ
entity "Customers" as Customers {
  * customer_id
  --
  * name
  * phone_number
  * created_at
    updated_at
    deleted_at
}

' 単品商品マスタ
entity "Products" as Products {
  * product_id
  --
  * product_name
  * created_at
    price_id<<FK>>
    category_id<<FK>>
    updated_at
    deleted_at
}

' 商品カテゴリマスタ
entity "Categorys" as Categorys {
  * category_id
  --
  * category_name
  * created_at
    updated_at
    deleted_at
}

note bottom of Categorys
  Categorys追加
  単品商品は「一皿」のみだが、今後増えることも考慮して
end note

' セット商品マスタ
entity "SetProducts" as SetProducts {
  * product_id
  --
  * product_name
  * created_at
    price_id<<FK>>
    category
    updated_at
    deleted_at
}

' セット商品カテゴリマスタ
entity "SetCategorys" as SetCategorys {
  * category_id
  --
  * category_name
  * created_at
    updated_at
    deleted_at
}

note bottom of SetCategorys
  SetCategorys追加
  （盛り込み、にぎりなど）
end note

' 商品金額テーブル
entity "Prices" as Prices {
  * price_id
  --
  * product_id<<FK>>
  * tax_id<<FK>>
  * price
  * started_at
    finished_at
    updated_at
    deleted_at
}

note left of Prices
  値上げや値下げなど、頻繁に変更がある可能性があるため
  商品マスタとは別で管理。（Sale時の一時的値下げなど）
  同じproductでも期間別に複数もてる想定。
end note

' 消費税マスタ
entity "Taxes" as Taxes {
  * tax_id
  --
  * tax_rate
  * started_at
    finished_at
}

' 注文テーブル
entity "Orders" as Orders {
  * order_id
  --
  * customer_id<<FK>>
    total_quantity
    paid_at
  * created_at
    updated_at
    deleted_at
}

note left of Orders
  total_fee（合計金額）を削除した。
  パフォーマンスが出せるかと思ったが、
  そんなに変わらないかもという疑惑が浮上したため。
end note

entity "OrderDetails" as OrderDetails {
  * order_detail_id
  --
  * order_id<<FK>>
  * product_id<<FK>>
    quantity
  * without_wasabi
  * created_at
    updated_at
    deleted_at
}

note top of OrderDetails
  subtotal_fee（小計金額）を削除した。
  パフォーマンスが出せるかと思ったが、
  そんなに変わらないかもという疑惑が浮上したため。
end note

Customers ||..o{ Orders
Orders ||..|{ OrderDetails
OrderDetails }o..|| Products
OrderDetails }o..|| SetProducts
Products ||..o{ Prices
SetProducts ||..o{ Prices
Products }o..|| Categorys
SetProducts }o..|| SetCategorys
Prices }o..|| Taxes

note as note1
  SetProductsを追加した。
  テーブルを分けてしまった方が集計が楽なのではないか
  と、議題に上がったのを受けて。
end note

@enduml