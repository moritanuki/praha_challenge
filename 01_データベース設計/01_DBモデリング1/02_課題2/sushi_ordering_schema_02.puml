@startuml sushi_ordering_schema_02

skinparam {
  ' カーディナリティ斜め対策
   linetype ortho
}

' 顧客マスタ
entity "Customers" as Customers {
  * customer_id
  --
  * name
  * phone_number
  * created_at
    updated_at
    deleted_at
}

' 商品マスタ
entity "Products" as Products {
  * product_id
  --
  * product_name
    type
  * created_at
    updated_at
    deleted_at
}

note left of Products
  <b>補足</b>
  ・type（単品かセットか）を追加。
  ・上記により、単品での集計が可能となった。
  ・種類が増える可能性を考え、enum（列挙型）とした。
end note

' 商品金額テーブル
entity "Prices" as Prices {
  * price_id
  --
  * product_id<<FK>>
  * tax_id<<FK>>
  * price
  * started_at
    finished_at
    updated_at
    deleted_at
}

' 消費税マスタ
entity "Taxes" as Taxes {
  * tax_id
  --
  * tax_rate
  * started_at
    finished_at
}

' 注文テーブル
entity "Orders" as Orders {
  * order_id
  --
  * customer_id<<FK>>
    total_fee
    total_quantity
    paid_at
  * created_at
    updated_at
    deleted_at
}

entity "OrderDetails" as OrderDetails {
  * order_detail_id
  --
  * order_id<<FK>>
  * product_id<<FK>>
  * price_id<<FK>>
  * order_detail_option_id<<FK>>
    subtotal_fee
    quantity
  * created_at
    updated_at
    deleted_at
}

note top of OrderDetails
  <b>補足</b>
  without_wasabi（さびぬき）オプションは元々ここにあった。
  ただ、しゃりの大小以外にもオプションが増えていく可能性を考え
  別テーブル（OrderDetailOptions）に抜き出した。
end note

entity "OrderDetailOptions" as OrderDetailOptions {
  * order_detail_option_id
  --
  * order_detail_id<<FK>>
  * without_wasabi
  * rice_size
  * created_at
    updated_at
    deleted_at
}

Customers ||..o{ Orders
Orders ||..|{ OrderDetails
OrderDetails ||..|| OrderDetailOptions
OrderDetails }o..|| Products
OrderDetails ||..|| Prices
Products ||..o{ Prices
Prices }o..|| Taxes

@enduml